# AstroTracker
Compact and lightweight tracker integrating the Astrocast communication module and u-blox CloudLocate service

### AstroTracker V0.6 REV2

Internal name: MiniTracker

![bottom](pictures/astrotracker_v06_rev2.jpg)

- U-blox MAX-M8/10 GNSS receiver, **shared antenna** with Astronode S communication module.
- MCU is SAM2121G18A, integrated below the Astronode S module (Astronode S is mounted on a PCB spacer).
- Astronode S + patch antenna communication module.
- Hardware watchdog using [TPL5010](https://www.ti.com/product/TPL5010)
- 2 pin JST connector for wired battery.
- Connectors: USB interface.
- **55x55mm**, 4 layers PCB design.

## Tracker to Operator - Message format

#### <code>LOG_PVT_struct</code> Logger PVT message

This structure contains the position, velocity and time (PVT) data generated by the GNSS receiver. 

|Byte offset|Type|Length (Bytes)|Name|Description|
|---|---|---|---|---|
|0|uint8_t|1|slot_tag|Message ID|
|1|uint32|4|Timestamp|Epoch of the measurement in UNIX time|
|5|int32|4|Latitude|Degrees Latitude * 1E7 (i.e., latitude multiplied by 10'000'000)|
|9|int32|4|Longitude|Degrees Longitude * 1E7 (i.e., longitude multiplied by 10'000'000)|
|13|uint8|1|SIV|Number of satellites used in fix|
|14|int32_t|4|gSpeed|Ground speed in mm/s|
|18|uint8|1|V Bat|Voltage of the battery in the tracker (multiplied by 10)|
|19|int8|1|Temperature|Temperature of the tracker in deg C (1 deg resolution)|

#### <code>LOG_RAW_struct</code> Logger RAW message

This structure contains the RAW data that can be uploaded to the CloudLocate service from U-blox to compute the location 
of the tracker. Do not forget to add the timestamp "created date" provided by the satellite communication module.

|Byte offset|Type|Length (Bytes)|Name|Description|
|---|---|---|---|---|
|0|uint8_t|1|slot_tag|Message ID|
|1|uint8_t|20|meas20|U-blox MEAS20 message|

#### <code>LOG_U_MSG_struct</code> Logger user message

This structure contains the text message queued by the user. This message can be directly read on the Astrocast portal.

|Byte offset|Type|Length (Bytes)|Name|Description|
|---|---|---|---|---|
|0|uint8_t|1|slot_tag|Message ID|
|1|uint8_t|40|data|User message data|

#### Message ID

List of message types that are stored in the logger of the tracker.

|Message|ID|
|---|---|
|LOGGER_TAG_PVT_SLOT|0x01|
|LOGGER_TAG_U_MSG_SLOT|0x02|
|LOGGER_TAG_U_CMD_SLOT|0x03|
|LOGGER_TAG_RAW_SLOT|0x04|

## Operator to Tracker - Command format

The tracker can execute a certain amount of commands trough the different available communication interfaces (Satellite, BLE, Mesh).
Here is the description of the transport layer. 
The protocol is inspired from the protocol used to communicate with the products from 
[Advanced Navigation](https://www.advancednavigation.com/)

<table>
    <thead>
        <tr>
            <th colspan="4">Header</th>
            <th>Data</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Header LRC</td>
            <td>Packet ID</td>
            <td>Packet Length</td>
            <td>CRC16</td>
            <td>Packet Data</td>
        </tr>
    </tbody>
</table>

A description of each field is provided in the following table:

|Byte offset|Type|Length (Bytes)|Name|Description|
|---|---|---|---|---|
|0|uint8_t|1|Header LRC|Longitudinal Redundancy Check. <br /> Error checking for the packet header.  <br /> LRC = ((packet_id + packet_length + crc[0] + crc[1])^0xFF) + 1|
|1|uint8_t|1|Packet ID|Used to distinguish the contents of the packet. IDs can be in the range 0-255.|
|2|uint8_t|1|Packet Length|Length of the data packet, from byte offset 5 included. Length can be in the range 0-255.|
|3|uint16_t|2|CRC16|CRC, CRC16-CCITT (start us 0xFFFF). Computed only over the data packet.|

The list of supported packet IDs and their description is provided below:

|Packet ID|Length|R/W|Description|
|---|---|---|---|
|0|4|R|Acknowledge packet|
|1|Varies|W|Request packet|
|2|44|R/W|Message data packet|
|3|43|R|Satellite status packet|
|4|8|R|Logger status packet|
|5|18|R|GPS status packet|
|6|6|R|BLE status packet|
|7|8|R|Asset status packet|
|11|8|W|Configuration packet|

#### <code>packet_id_acknowledge</code> Acknowledge packet

    typedef struct __attribute__((__packed__))
    {
        uint8_t packet_id;
        uint16_t packet_crc;
        uint8_t acknowledge_result;
    } acknowledge_packet_t;

#### <code>packet_id_msg_data</code> Message data packet

    typedef struct __attribute__((__packed__))
    {
        uint8_t data[40];
        uint32_t acknowledgedDate;
    } msg_data_packet_t;

#### <code>packet_id_sat_status</code> Satellite status packet

    typedef struct __attribute__((__packed__))
    {
        uint32_t sat_detect_operation_cnt;
        uint32_t signal_demod_attempt_cnt;
        uint32_t ack_demod_attempt_cnt;
        uint32_t sent_fragment_cnt;
        uint32_t ack_fragment_cnt;
        uint32_t queued_msg_cnt;
        uint32_t time_start_last_contact;
        uint32_t time_end_last_contact;
        uint8_t peak_rssi_last_contact;
        uint32_t time_peak_rssi_last_contact;
        uint16_t reset_cnt;
        uint32_t uptime;
    } sat_status_packet_t;

#### <code>packet_id_logger_status</code> Logger status packet

    typedef struct __attribute__((__packed__))
    {
        uint16_t u_msg_cnt;
        uint16_t u_cmd_cnt;
        uint16_t pvt_cnt;
        uint16_t raw_cnt;
    } logger_status_packet_t;

#### <code>packet_id_gps_status</code> GPS status packet

    typedef struct __attribute__((__packed__))
    {
        uint16_t meas_cnt;
        int32_t last_loc_lat;
        int32_t last_loc_lon;
        uint32_t time_last_update;
        uint32_t uptime;
    } gps_status_packet_t;

#### <code>packet_id_ble_status</code> BLE status packet

    typedef struct __attribute__((__packed__))
    {
        uint32_t advert_burst_cnt;
        uint16_t user_connection_cnt;
    } ble_status_packet_t;

#### <code>packet_id_asset_status</code> Asset status packet

    typedef struct __attribute__((__packed__))
    {
        uint32_t up_time_ms;
        uint32_t sys_time;
    } asset_status_packet_t;

#### <code>packet_id_config</code> Configuration packet

    typedef struct __attribute__((__packed__))
    {
        // GPS config
        bool gps_settings_with_gps;
        bool gps_settings_with_galileo;
        bool gps_settings_with_beidou;
        bool gps_settings_with_glonass;
        bool gps_settings_with_rxm_meas20;
        uint8_t gps_settings_raw_timeout_s;
    
        // sat modem config
        bool sat_settings_with_pld_ack;
        bool sat_settings_with_geo_loc;
        bool sat_settings_with_ephemeris;
        bool sat_settings_with_deep_sleep_en;
        bool sat_settings_with_msg_ack_pin_en;
        bool sat_settings_with_msg_reset_pin_en;
        bool sat_settings_with_cmd_event_pin_en;
        bool sat_settings_with_tx_pend_event_pin_en;
        bool sat_settings_sat_force_search;
        uint8_t sat_settings_sat_search_rate;
    
        // Scheduler config
        uint8_t scheduler_settings_gps_interval_h;
        uint8_t gps_settings_pvt_timeout_s;
    
        // Asset status
        uint8_t battery_low_threshhold;
    
    } config_packet_t;

The following table explains which commands are available for which communication interface:

|Packet ID|Packet Name|Satellite|BLE|Mesh|
|---|---|---|---|---|
|0|Acknowledge packet|❌|✅|❌|
|1|Request packet|❌|✅|❌|
|2|Message data packet|✅|✅|❌|
|3|Satellite status packet|❌|✅|❌|
|4|Logger status packet|❌|✅|❌|
|5|GPS status packet|❌|✅|❌|
|6|BLE status packet|❌|✅|❌|
|7|Asset status packet|❌|✅|❌|
|11|Configuration packet|✅|✅|❌|


## Copyright

AstroTracker Copyright (C) 2023 valcesch

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 3 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program; if not, write to the Free Software Foundation,
Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
